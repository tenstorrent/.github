name: Set "Opened On" in Project

on:
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'  # Run every 15 minutes

permissions:
  contents: read
  repository-projects: write
  organization-projects: write

jobs:
  set-opened-on:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.DATE_AUTOMATION }}
      PROJECT_ID: "PVT_kwDOA9MHEM4AgKVv"
      FIELD_ID: "PVTF_lADOA9MHEM4AgKVvzg4bxWU"
    steps:
      - name: Process Project Items
        run: |
          set +e  # Don't exit on errors, handle them per-item
          
          if [ -z "$GH_TOKEN" ]; then
            echo "Error: GH_TOKEN (DATE_AUTOMATION secret) is not set" >&2
            exit 1
          fi

          # Fetch all items from the project
          echo "Fetching items from project..."
          PROJECT_DATA=$(gh api graphql -f query='
          query($projectId:ID!){
            node(id:$projectId){
              ... on ProjectV2 {
                items(first:100){
                  nodes{
                    id
                    fieldValueByName(name:"Opened On"){
                      ... on ProjectV2ItemFieldDateValue {
                        date
                      }
                    }
                    content{
                      ... on Issue {
                        id
                        number
                        createdAt
                      }
                    }
                  }
                  pageInfo{
                    hasNextPage
                    endCursor
                  }
                }
              }
            }
          }' -F projectId="$PROJECT_ID" 2>&1)

          # Check for errors fetching project data
          if [ $? -ne 0 ] || ! echo "$PROJECT_DATA" | jq -e '.data.node.items' > /dev/null 2>&1; then
            echo "Error: Failed to fetch project data" >&2
            echo "Response: $PROJECT_DATA" >&2
            exit 1
          fi

          # Extract items that need processing (issues without "Opened On" date)
          ITEMS_TO_PROCESS=$(echo "$PROJECT_DATA" | jq -c '.data.node.items.nodes[] | select(.content.id != null and (.fieldValueByName.date == null or .fieldValueByName.date == ""))')
          
          if [ -z "$ITEMS_TO_PROCESS" ]; then
            echo "No items need processing - all issues have 'Opened On' date set"
            exit 0
          fi

          TOTAL_COUNT=$(echo "$ITEMS_TO_PROCESS" | wc -l | tr -d ' ')
          echo "Found $TOTAL_COUNT item(s) to process"
          
          # Check for pagination warning
          HAS_NEXT_PAGE=$(echo "$PROJECT_DATA" | jq -r '.data.node.items.pageInfo.hasNextPage')
          if [ "$HAS_NEXT_PAGE" = "true" ]; then
            echo "⚠️  Warning: Project has more than 100 items. Only processing first 100." >&2
          fi
          echo ""

          SUCCESS_COUNT=0
          ERROR_COUNT=0

          # Process each item (use process substitution to avoid subshell)
          while IFS= read -r item; do
            ITEM_ID=$(echo "$item" | jq -r '.id')
            ISSUE_NUMBER=$(echo "$item" | jq -r '.content.number')
            ISSUE_CREATED=$(echo "$item" | jq -r '.content.createdAt')

            # Validate extracted values before processing
            if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ] || \
               [ -z "$ISSUE_NUMBER" ] || [ "$ISSUE_NUMBER" = "null" ] || \
               [ -z "$ISSUE_CREATED" ] || [ "$ISSUE_CREATED" = "null" ]; then
              echo "✗ Skipping item due to missing required data (ITEM_ID='$ITEM_ID', ISSUE_NUMBER='$ISSUE_NUMBER', ISSUE_CREATED='$ISSUE_CREATED')" >&2
              ERROR_COUNT=$((ERROR_COUNT + 1))
              echo ""
              continue
            fi

            OPENED_DATE="${ISSUE_CREATED%%T*}"
            echo "Processing issue #$ISSUE_NUMBER..."

            # Set the "Opened On" field value
            UPDATE_RESP=$(gh api graphql -f query='
            mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $date:Date!){
              updateProjectV2ItemFieldValue(input:{
                projectId:$projectId,
                itemId:$itemId,
                fieldId:$fieldId,
                value:{ date:$date }
              }){
                projectV2Item{ id }
              }
            }' \
            -F projectId="$PROJECT_ID" \
            -F itemId="$ITEM_ID" \
            -F fieldId="$FIELD_ID" \
            -F date="$OPENED_DATE" 2>&1)

            if [ $? -eq 0 ] && echo "$UPDATE_RESP" | jq -e '.data.updateProjectV2ItemFieldValue.projectV2Item.id' > /dev/null 2>&1; then
              echo "✓ Successfully set 'Opened On' to $OPENED_DATE for issue #$ISSUE_NUMBER"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "✗ Error setting 'Opened On' for issue #$ISSUE_NUMBER" >&2
              
              # Try to extract error details
              if echo "$UPDATE_RESP" | jq -e '.errors' > /dev/null 2>&1; then
                echo "  Error details:" >&2
                echo "$UPDATE_RESP" | jq -r '.errors[] | "  - \(.message)"' >&2
              else
                echo "  Response: $UPDATE_RESP" >&2
              fi
              
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
            echo ""
          done < <(echo "$ITEMS_TO_PROCESS")

          echo "Processing complete: $SUCCESS_COUNT succeeded, $ERROR_COUNT failed"
          
          # Exit with error if all items failed
          if [ "$ERROR_COUNT" -gt 0 ] && [ "$SUCCESS_COUNT" -eq 0 ]; then
            echo "Error: All items failed to process" >&2
            exit 1
          fi
          
          exit 0
